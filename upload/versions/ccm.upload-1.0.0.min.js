(function(){var component={name:"upload",version:[1,0,0],ccm:{url:"https://akless.github.io/ccm/version/ccm-10.0.0.min.js",integrity:"sha384-EyEx2M7vmFe85ReAzY7pE8lPePRHb5YyEuVBKrfI3RugbCER4bn+9rmPAmC3vn9Y",crossorigin:"anonymous"},config:{key:"test",keys:{semester:1,fach:"se",id:"portrait"},server:"https://kaul.inf.h-brs.de/data/form.php",upload_size:100,upload_time:80,content_type:"image/*",type_regex:"image/.*",suffix_regex:".jpeg$|.jpg$|.png$|.pdf$",html:{main:{tag:"form",inner:[{tag:"input",type:"file",accept:"%accept%"},{tag:"progress",min:"0",max:"100",value:"0",inner:"0% complete"},{tag:"button",id:"abort",inner:"Abort"},{id:"reports"},{id:"failure"}]},response:{tag:"a",target:"_blank",inner:"%name%"}},language:"de",messages:{en:{abort:"Upload cancelled: ",success:"Upload successful: ",file_too_large:"File too large",wrong_file_type:"Wrong file type",wrong_suffix:"Wrong file suffix"},de:{abort:"Upload abgebrochen: ",success:"Fertig hochgeladen: ",file_too_large:"Datei zu groÃŸ",wrong_file_type:"Falscher Datei-Typ",wrong_suffix:"Falsche Datei-Endung"}},css:["ccm.load","https://kaul.inf.h-brs.de/data/ccm/upload/resources/default.css"],user:["ccm.instance","https://akless.github.io/ccm-components/user/versions/ccm.user-1.0.0.min.js",{realm:"hbrsinfkaul"}]},Instance:function(){var self=this;this.start=function(callback){if(self.logger)self.logger.log("render");var main_elem=self.ccm.helper.html(self.html.main,{accept:self.content_type});var input=main_elem.querySelector("input");var progress_bar=main_elem.querySelector("progress");var abort_button=main_elem.querySelector("#abort");var reports=main_elem.querySelector("#reports");var failure=main_elem.querySelector("#failure");self.ccm.helper.setContent(self.element,main_elem);self.root.ccm_instance=self;var xhr;var params={key:self.key};Object.assign(params,self.keys);if(self.root.id)params.id=self.root.id;input.addEventListener("change",selectFile,false);abort_button.addEventListener("click",abort,false);self.sync=function(event_or_value){if(event_or_value!=="undefined"&&event_or_value&&!(event_or_value instanceof Event)){self.value=JSON.parse(event_or_value)}Object.assign(params,self.value);report_file_link();if(self.logger)self.logger.log(params);if(event_or_value instanceof Event){event_or_value.preventDefault();event_or_value.stopPropagation();return false}};function selectFile(){var file=this.files[0];params.name=file.name;self.sync=function(event_or_value){if(event_or_value!=="undefined"&&event_or_value&&!(event_or_value instanceof Event)){self.value=JSON.parse(event_or_value)}else{self.value={name:file.name,size:file.size,type:file.type}}Object.assign(params,self.value);report_file_link();if(self.logger)self.logger.log(params);if(event_or_value instanceof Event){event_or_value.preventDefault();event_or_value.stopPropagation();return false}};if(file.name.split(".").slice(-1)[0].toUpperCase()==="PHP"){alert(self.messages[self.language].wrong_file_type);return false}if(file.size>self.upload_size*1024*1024){alert(self.messages[self.language].file_too_large);return false}function wrong_file_type(file){return self.type_regex&&!file.type.match(self.type_regex)&&self.suffix_regex&&!file.name.match(self.suffix_regex)}if((self.type_regex||self.suffix_regex)&&wrong_file_type(file)){if(self.type_regex&&!file.type.match(self.type_regex)){reports.textContent="File type is "+file.type+", required is type "+self.type_regex;alert(self.messages[self.language].wrong_file_type);return false}if(self.suffix_regex&&!file.name.match(self.suffix_regex)){reports.textContent="File type is "+file.type+", required is suffix "+self.suffix_regex;alert(self.messages[self.language].wrong_suffix);return false}}xhr=new XMLHttpRequest;reports.textContent="";failure.textContent="";var formData=new FormData;formData.append("key",self.key);formData.append("file",file);xhr.open("POST",self.upload_server?self.upload_server:self.server,true);xhr.upload.onprogress=function(e){if(e.lengthComputable){progress_bar.value=e.loaded/e.total*100;progress_bar.textContent=progress_bar.value}};function error_message(event){return" Status: "+xhr.status+", Event: "+JSON.stringify(event)+", Response: "+xhr.response+"."}xhr.upload.onabort=function(event){failure.textContent+="Abort"+error_message(event)};xhr.upload.onerror=function(event){failure.textContent+="Error"+error_message(event)};xhr.upload.ontimeout=function(event){failure.textContent+="Timeout"+error_message(event)+" Max. time for upload is "+self.upload_time+" sec."};xhr.onload=function(){if(this.status==200){report_file_link();if(self.logger)self.logger.log(params)}};if(self.user)self.user.login(proceed);else proceed();function proceed(){Object.assign(params,{user:self.user.data().user,token:self.user.data().token});Object.keys(params).map(function(key){formData.append(key,params[key])});xhr.send(formData)}function log_form(x){console.log(x);var result={};for(var entry of formData.entries()){result[entry[0]]=entry[1]}result=JSON.stringify(result);console.log(result);return JSON.stringify(formData.entries())}}function abort(e){xhr.abort();e.preventDefault();e.stopPropagation();return false}function report_file_link(){reports.textContent=self.messages[self.language].success;var element=self.ccm.helper.html(self.html.response,params);element.href=file_url(self.server,params);reports.appendChild(element)}function file_url(server,params){var url=server;var whitelist=["key","user","token"].concat(Object.keys(self.keys));Object.keys(params).map(function(key,i){if(whitelist.indexOf(key)>-1){url+=(i===0?"?":"&")+key+"="+encodeURIComponent(params[key])}});return url}if(callback)callback()}}};function p(){window.ccm[v].component(component)}var f="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[f])window.ccm.files[f]=component;else{var n=window.ccm&&window.ccm.components[component.name];n&&n.ccm&&(component.ccm=n.ccm),"string"==typeof component.ccm&&(component.ccm={url:component.ccm});var v=component.ccm.url.split("/").pop().split("-");if(v.length>1?(v=v[1].split("."),v.pop(),"min"===v[v.length-1]&&v.pop(),v=v.join(".")):v="latest",window.ccm&&window.ccm[v])p();else{var e=document.createElement("script");document.head.appendChild(e),component.ccm.integrity&&e.setAttribute("integrity",component.ccm.integrity),component.ccm.crossorigin&&e.setAttribute("crossorigin",component.ccm.crossorigin),e.onload=function(){p(),document.head.removeChild(e)},e.src=component.ccm.url}}})();